# -*- encoding : utf-8 -*-
module ProductLanguages

  # "iso codes" come from the "language tag subregisty". http://www.iana.org/assignments/language-subtag-registry, which is
  # apparently based on iso 639 standards.
  # they look like "en", "en-US", "es-419", "fr-FR", "zh-Hant-CN" etc. do not be alarmed if it doesn't look like a standard.
  # see also https://trac.lan.flt/CDT/wiki/LanguageCodes, which is authoritative on (at least) the RS3 language codes
  LANGUAGE_DATA = {"ALL" => { :translation_key => "pl_ALL558920407", :display_name => "ALL", :iso_code => nil },
                   "AEN" => { :translation_key => "pl_English_US_Automotive110260458", :display_name => "English (US) Automotive", :iso_code => nil },
                   "ARA" => { :translation_key => "pl_Arabic802773623", :display_name => "Arabic", :iso_code => 'ar', :parature_code => '4109' },
                   "ASP" => { :translation_key => "pl_Spanish_Automotive972513567", :display_name => "Spanish Automotive", :iso_code => nil },
                   "CHI" => { :translation_key => "pl_Chinese_Mandarin102265264", :display_name => "Chinese (Mandarin)", :iso_code => 'zh-CN', :parature_code => '4110' },
                   "CYM" => { :translation_key => "pl_Welsh592936497", :display_name => "Welsh", :iso_code => nil },
                   "CTM" => { :translation_key => "pl_Chitimacha277531536", :display_name => "Chitimacha", :iso_code => 'cm-US', :max_v3_unit => 8 },
                   "DAN" => { :translation_key => "pl_Danish788367677", :display_name => "Danish", :iso_code => nil },
                   "DEU" => { :translation_key => "pl_German542354433", :display_name => "German", :iso_code => 'de-DE', :parature_code => '4111' },
                   #Note that this is for V2 only.  Check out V3_LANGUAGE_DATA for V3 translations
                   "EBR" => { :translation_key => "pl_English_UK228192618", :display_name => "English (UK)", :iso_code => 'en-GB', :parature_code => '4112' },
                   "ECT" => { :translation_key => "pl_English__US626956010", :display_name => "English - US", :iso_code => nil },
                   #Note that this is for V2 only.  Check out V3_LANGUAGE_DATA for V3 translations
                   "ENG" => { :translation_key => "pl_English_US228733810", :display_name => "English (US)", :iso_code => 'en-US', :parature_code => '4113' },
                   "ESC" => { :translation_key => "pl_Spanish_Spain45261054", :display_name => "Spanish (Spain)", :iso_code => 'es-ES', :parature_code => '4114' },
                   "ESP" => { :translation_key => "pl_Spanish_Latin_America960560516", :display_name => "Spanish (Latin America)", :iso_code => 'es-419', :parature_code => '4115' },
                   #Note that this is for V2 only.  Check out V3_LANGUAGE_DATA for V3 translations
                   "FAR" => { :translation_key => "pl_Farsi273711229", :display_name => "Farsi", :iso_code => 'fa-IR', :parature_code => '4116' },
                   "FRA" => { :translation_key => "pl_French533980333", :display_name => "French", :iso_code => 'fr-FR', :parature_code => '4117' },
                   "GLE" => { :translation_key => "pl_Irish856932068", :display_name => "Irish", :iso_code => 'ga-IE', :parature_code => '4118' },
                   "GRK" => { :translation_key => "pl_Greek1052658092", :display_name => "Greek", :iso_code => 'el-GR', :parature_code => '4119' },
                   "HEB" => { :translation_key => "pl_Hebrew292013302", :display_name => "Hebrew", :iso_code => 'he-IL', :parature_code => '4120' },
                   "HIN" => { :translation_key => "pl_Hindi376978982", :display_name => "Hindi", :iso_code => 'hi-IN', :parature_code => '4121' },
                   "IKU" => { :translation_key => "pl_Inuttitut907761204", :display_name => "Inuttitut", :iso_code => 'iu' },
                   "IND" => { :translation_key => "pl_Indonesian965819803", :display_name => "Indonesian", :iso_code => 'id-ID', :max_v3_unit => 4 },
                   "INU" => { :translation_key => "pl_Inupiaq889405201", :display_name => "Inupiaq", :iso_code => 'ik-CO' },
                   "IPN" => { :translation_key => "pl_Iupiaq_North_Slope266EBF77", :display_name => "IÃ±upiaq (North Slope)", :iso_code => 'ik-NS'},
                   "ITA" => { :translation_key => "pl_Italian761173052", :display_name => "Italian", :iso_code => 'it-IT', :parature_code => '4122' },
                   "JPN" => { :translation_key => "pl_Japanese389742226", :display_name => "Japanese", :iso_code => 'ja-JP', :parature_code => '4123' },
                   "KAL" => { :translation_key => "pl_Kalaalisut1043304145", :display_name => "Kalaalisut", :iso_code => nil },
                   "KIS" => { :translation_key => "pl_Swahili313645658", :display_name => "Swahili", :iso_code => 'sw-TZ', :max_v3_unit => 4 },
                   "KOR" => { :translation_key => "pl_Korean611780363", :display_name => "Korean", :iso_code => 'ko-KR', :parature_code => '4124' },
                   "LAT" => { :translation_key => "pl_Latin82819279", :display_name => "Latin", :iso_code => 'la' },
                   "LUX" => { :translation_key => "pl_Luxembourgish1072140344", :display_name => "Luxembourgish", :iso_code => nil },
                   "MIC" => { :translation_key => "pl_Miccosukee344264560", :display_name => "Miccosukee", :iso_code => nil },
                   "MOH" => { :translation_key => "pl_Mohawk931458675", :display_name => "Mohawk", :iso_code => 'ma' },
                   "NAV" => { :translation_key => "pl_Navajo560664987", :display_name => "Navajo", :iso_code => 'nv', :max_v3_unit => 8 },
                   "NED" => { :translation_key => "pl_Dutch69732574", :display_name => "Dutch", :iso_code => 'nl-NL', :parature_code => '4125' },
                   "PAS" => { :translation_key => "pl_Pashto1026697517", :display_name => "Pashto", :iso_code => 'ps-AF', :max_v3_unit => 4 },
                   "PDE" => { :translation_key => "pl_German542354433", :display_name => "German", :iso_code => nil },
                   "PEN" => { :translation_key => "pl_English_US228733810", :display_name => "English (US)", :iso_code => nil },
                   "PES" => { :translation_key => "pl_Spanish_Latin_America960560516", :display_name => "Spanish (Latin America)", :iso_code => nil },
                   "PFR" => { :translation_key => "pl_French533980333", :display_name => "French", :iso_code => nil },
                   "PIT" => { :translation_key => "pl_Italian761173052", :display_name => "Italian", :iso_code => nil },
                   "POL" => { :translation_key => "pl_Polish940980035", :display_name => "Polish", :iso_code => 'pl-PL', :parature_code => '4126' },
                   #Note that this is for V2 only.  Check out V3_LANGUAGE_DATA for V3 translations
                   "POR" => { :translation_key => "pl_Portuguese84996506", :display_name => "Portuguese", :iso_code => 'pt-BR', :parature_code => '4127' },
                   "RUS" => { :translation_key => "pl_Russian592731001", :display_name => "Russian", :iso_code => 'ru-RU', :parature_code => '4128' },
                   "SVE" => { :translation_key => "pl_Swedish352583952", :display_name => "Swedish", :iso_code => 'sv-SE', :parature_code => '4129' },
                   #Note that this is for V2 only.  Check out V3_LANGUAGE_DATA for V3 translations
                   "TGL" => { :translation_key => "pl_Tagalog697191499", :display_name => "Tagalog", :iso_code => 'tl-PH', :parature_code => '4130' },
                   "THA" => { :translation_key => "pl_Thai74284426", :display_name => "Thai", :iso_code => 'th-TH' },
                   "TUR" => { :translation_key => "pl_Turkish795686692", :display_name => "Turkish", :iso_code => 'tr-TR', :parature_code => '4131' },
                   "VEN" => { :translation_key => "pl_English_US_Vergara419173165", :display_name => "English (US) Vergara", :iso_code => nil },
                   "VES" => { :translation_key => "pl_Spanish_Vergara677875473", :display_name => "Spanish Vergara", :iso_code => nil },
                   "VIE" => { :translation_key => "pl_Vietnamese841604876", :display_name => "Vietnamese", :iso_code => 'vi-VN', :parature_code => '4132' },
                   "TCH" => { :translation_key => "pl_Public_Library_Edition_Chinese_Mandarin934589464", :display_name => "Public Library Edition: Chinese (Mandarin)", :iso_code => nil },
                   "TDE" => { :translation_key => "pl_Public_Library_Edition_German194377081", :display_name => "Public Library Edition: German", :iso_code => nil },
                   "TEB" => { :translation_key => "pl_Public_Library_Edition_English_UK926935149", :display_name => "Public Library Edition: English (UK)", :iso_code => nil },
                   "TEN" => { :translation_key => "pl_Public_Library_Edition_English_US926393958", :display_name => "Public Library Edition: English (US)", :iso_code => nil },
                   "TES" => { :translation_key => "pl_Public_Library_Edition_Spanish_Latin_America344510716", :display_name => "Public Library Edition: Spanish (Latin America)", :iso_code => nil },
                   "TEC" => { :translation_key => "pl_Public_Library_Edition_Spanish_Spain844499722", :display_name => "Public Library Edition: Spanish (Spain)", :iso_code => nil },
                   "TFR" => { :translation_key => "pl_Public_Library_Edition_French186002980", :display_name => "Public Library Edition: French", :iso_code => nil },
                   "TRU" => { :translation_key => "pl_Public_Library_Edition_Russian501469199", :display_name => "Public Library Edition: Russian", :iso_code => nil },
                   "TGR" => { :translation_key => "pl_Public_Library_Edition_Greek1042361619", :display_name => "Public Library Edition: Greek", :iso_code => nil },
                   "TIN" => { :translation_key => "pl_Public_Library_Edition_Italian157892669", :display_name => "Public Library Edition: Italian", :iso_code => nil },
                   "IRQ" => { :translation_key => "pl_Arabic__Iraqi148809718", :display_name => "Arabic (Iraq)", :iso_code => 'ar-IQ', :parature_code => nil, :max_v3_unit => 4 },
                   "DAR" => { :translation_key => "pl_Dari399197097", :display_name => "Dari", :iso_code => 'fa-AF', :parature_code => nil, :max_v3_unit => 4 },
                   "URD" => { :translation_key => "pl_Urdu1465605523", :display_name => "Urdu", :iso_code => 'ur-PK', :parature_code => nil, :max_v3_unit => 4 },
                   "ME-ARA" => { :translation_key => "pl_Military_Arabic690847342", :display_name => "Arabic | Military", :iso_code => nil, :max_v3_unit => 4 },
                   "ME-DAR" => { :translation_key => "pl_Military_Dari6403E68D", :display_name => "Dari | Military", :iso_code => nil, :max_v3_unit => 4 },
                   "ME-IND" => { :translation_key => "pl_Military_Indonesian911C6E4C", :display_name => "Indonesian | Military", :iso_code => nil, :max_v3_unit => 4 },
                   "ME-IRQ" => { :translation_key => "pl_Military_Arabic_Iraq1CCC5020", :display_name => "Arabic (Iraq) | Military", :iso_code => nil, :max_v3_unit => 4 },
                   "ME-KIS" => { :translation_key => "pl_Military_SwahiliD5AB907C", :display_name => "Swahili | Military", :iso_code => nil, :max_v3_unit => 4 },
                   "ME-PAS" => { :translation_key => "pl_Military_Pashto31FA5A53", :display_name => "Pashto | Military", :iso_code => nil, :max_v3_unit => 4 },
                   "ME-URD" => { :translation_key => "pl_Military_Urdu9A5F22C6", :display_name => "Urdu | Military", :iso_code => nil, :max_v3_unit => 4 },
                   "KLE" => { :translation_key => "pl_English_Korea2CCAF865", :display_name => "English (Korea)", :iso_code => 'en-KR' },
                   "JLE" => { :translation_key => "pl_English_Japan723EE939", :display_name => "English (Japan)", :iso_code => 'en-JP' },
                   "BLE" => { :translation_key => "pl_English_Brazil2BB33C3B", :display_name => "English (Brazil)", :iso_code => 'en-BR' },
                   "CLE" => { :translation_key => "pl_English_ChinaF9F49967", :display_name => "English (China)", :iso_code => 'en-CN' },
                   "PT-ENG" => { :translation_key => "pl_English_American_Placement_TestD208448B", :display_name => "English (American) Placement", :iso_code => nil, :max_v3_unit => 4 },
  # Korean PAL (Proctor Assisted Learning)
      "PA-ENG" => { :translation_key => "pl_English_American843014980", :display_name => "English (American-PAL)", :iso_code => nil }
  }

  ISO_CODE_MAP = LANGUAGE_DATA.inject({}){ |memo, val| memo[val.first] = val.last[:iso_code]; memo }

  # We'll assume here that there will be a v3 of every language we currently offer someday (though that is unlikely).
  # This is used primarily as an override when the name of the v3 product is different from the name of the v2 product.
  # If we add a language code here that does not exist in LANGUAGE_DATA, valid_codes below will need to be updated.
  V3_LANGUAGE_DATA = LANGUAGE_DATA.merge({
                   "EBR" => LANGUAGE_DATA['EBR'].merge({:translation_key => "pl_English_British977356377", :display_name => "English (British)"}),
                   "ENG" => LANGUAGE_DATA['ENG'].merge({:translation_key => "pl_English_American843014980", :display_name => "English (American)"}),
                   "FAR" => LANGUAGE_DATA['FAR'].merge({:translation_key => "pl_Persian_Farsi185972354", :display_name => "Persian (Farsi)"}),
                   "POR" => LANGUAGE_DATA['POR'].merge({:translation_key => "pl_Portuguese_Brazil279796935", :display_name => "Portuguese (Brazil)"}),
                   "TGL" => LANGUAGE_DATA['TGL'].merge({:translation_key => "pl_Filipino_Tagalog687280263", :display_name => "Filipino (Tagalog)"}),
                 })

  class << self
    # This hard-coded list of "standard" language codes is largely meant to be used temporarily, to implement some
    # rules for displaying ancillary docs that are related to our RS/RW standard product offerings.  In the near future,
    # we hope to replace those rules with dynamic lookup of Available Products (and/or Product Rights) to customize
    # product-related documentation to specific OLLCs/users.  Famous last words, eh?
    def rs2_standard_language_codes
      %w[ARA CHI CYM DAN DEU  EBR ENG ESC ESP FAR  FRA GRK HEB HIN IND
         ITA JPN KIS KOR LAT  NED PAS POL POR RUS  SVE TGL THA TUR VIE]
    end

    # excludes nonstandard language codes (ME-ARA, ECT, CTM, NAV, IRQ), because it doesn't seem like most people should see them
    def rs3_standard_language_codes
      %w[ARA DEU EBR ENG ESC ESP FRA ITA POR RUS
         CHI JPN HEB GLE
         KOR FAR POL HIN SVE GRK NED
         TUR VIE LAT TGL] +
         gobots_language_codes
    end

    # beware of IRQ, as it is currently only intended for military
    # these are the personal edition ones...
    def gobots_language_codes
      %w[DAR IND PAS KIS URD]
    end

    def eschool_language_codes
      %w[ARA CHI DEU EBR ENG ESC ESP FRA ITA JPN POR RUS JLE KLE BLE CLE]
    end

    def rs3_level_4_and_5_language_codes
      %w[ESP FRA DEU ITA ESC ENG EBR CHI RUS]
    end

    def rs3_level_4_and_5_iso_codes
      rs3_level_4_and_5_language_codes.map{|three_letter_code| iso_code_for(three_letter_code)}
    end

    def has_level_4_and_5?(rs_or_iso_code)
      if valid_codes.include?(rs_or_iso_code)
        rs3_level_4_and_5_language_codes.include?(rs_or_iso_code)
      elsif valid_iso_codes.include?(rs_or_iso_code)
        rs3_level_4_and_5_iso_codes.include?(rs_or_iso_code)
      else
        false
      end
    end

    def max_v3_unit_for_rs_code(rs_code)
      rs_code = rs_code.to_s.upcase
      data_hash = LANGUAGE_DATA[rs_code]
      return nil if data_hash.nil?
      return data_hash[:max_v3_unit] if data_hash.has_key?(:max_v3_unit)

      if ProductLanguages.gobots_language_codes.include?(rs_code)
        4 # gobots languages are level 1 only says JC
      else
        has_level_4_and_5?(rs_code) ? 20 : 12
      end
    end

    def max_v3_level_for_rs_code(rs_code)
      max_v3_unit_for_rs_code(rs_code).if_hot {|unit| (unit.to_f/4).ceil}
    end

    def military_edition_language_codes
      valid_codes.grep(/^ME-/)
    end

    def placement_test_language_codes
      valid_codes.grep(/^PT-/)
    end

    def oe_language_codes
      rs3_standard_language_codes - %w(LAT) - gobots_language_codes
    end

    def is_reflex_language_code?(language_code)
      reflex_language_codes.include?(language_code.to_s.upcase)
    end

    def reflex_language_codes
      %w(KLE JLE BLE CLE)
    end
    alias_method :lotus_language_codes, :reflex_language_codes

    def standard_language_codes
      (rs2_standard_language_codes + rs3_standard_language_codes).uniq.sort
    end

    def all_language_data
      V3_LANGUAGE_DATA # yes, this is misleading. see comments above V3_LANGUAGE_DATA for why this is the comprehensive list
    end

    # v2 only
    def traveler_edition_language_codes
      %w[TCH TDE TEB TEN TES  TEC TFR TRU TGR TIN]
    end

    # v2 only
    def professional_edition_language_codes
      %w[PEN PES PFR PIT PDE]
    end

    def iso_code_for(three_letter_code)
      LANGUAGE_DATA[three_letter_code] ? LANGUAGE_DATA[three_letter_code][:iso_code] : nil
    end

    def parature_code_for(three_letter_code)
      LANGUAGE_DATA[three_letter_code] ? LANGUAGE_DATA[three_letter_code][:parature_code] : nil
    end

    def rs_code_from_iso_code(iso_code)
      ISO_CODE_MAP.invert[iso_code.to_s]
    end

    def valid_codes
      LANGUAGE_DATA.keys
    end

    def valid_code?(three_letter_code)
      valid_codes.include?(three_letter_code)
    end

    def valid_iso_codes
      ISO_CODE_MAP.values.compact
    end

    def valid_oe_iso_codes
      oe_language_codes.map{|rscode|iso_code_for(rscode)}.compact
    end

    def valid_reflex_iso_codes
      reflex_language_codes.map{|rscode|iso_code_for(rscode)}.compact
    end

    def iso_language_code_for_rs3_course_identifier(course_identifier)
      iso_code_for(language_code_for_rs3_course_identifier(course_identifier))
    end

    def language_code_for_rs3_course_identifier(course_identifier)
      ignore, language_code, ignore, ignore, edition = course_identifier.to_s.split('-')
      language_code = [edition, language_code].join('-') unless edition == 'PE'
      language_code if valid_codes.include?(language_code)
    end

    def level_for_rs3_course_identifier(course_identifier)
      ignore, ignore, level_code = course_identifier.to_s.split('-')
      return nil if level_code.blank? || level_code.to_s.length < 2
      level_code.to_s.substr(1)
    end

    def edition_for_rs3_course_identifier(course_identifier)
      course_identifier.to_s.split('-')[4]
    end

    def display_name_from_code_and_version(language_code, version, options = {})
      options[:translation] = true unless options.has_key?(:translation)
      options[:do_spanify] = true unless options.has_key?(:do_spanify)
      codes = (version.to_i == 2 ? LANGUAGE_DATA : V3_LANGUAGE_DATA)
      if codes[language_code] && codes[language_code][:display_name]
        lang_name = codes[language_code][:display_name]
        if options[:translation]
          if Object.respond_to?(:unharvested_translate)
            # this would be Lion
            unharvested_translate(codes[language_code][:translation_key], {}, options[:do_spanify])
          elsif Object.respond_to?(:_)
            # this would be gettext
            _(lang_name)
          else
            # no recognized translation system, return it untranslated
            lang_name
          end
        else
          lang_name
        end
      else
        logger.error("unrecognized language code: #{language_code}")
        return ''
      end
    end

    def display_name_from_product_string(product_string, options = {})
      options[:display_version] ? name_and_version_for(product_string, options) : display_name_from_code_and_version(product_identifier_from(product_string), product_version_from(product_string), options)
    end

    # The following method takes an Available Product (or a Product Right), rather than a product_string.
    # Both of those models should respond to product_identifier and product_version methods, so woot.
    def display_name(ap_or_pr, options = {})
      display_name_from_product_string(ap_or_pr.product_string, options)
    end

    # Always call out version = 3 here? I dunno, seems like this sort of
    # interface locale-related functionality should be separated from product
    # language stuff.
    def display_name_from_iso_code(iso_code, options = {})
      display_name_from_code_and_version(rs_code_from_iso_code(iso_code), 3, options)
    end

    # this doesn't really belong here but I don't know where else to put it.
    # please be aware that content can override these default values and this will be wrong.
    # please be aware that custom viper curricula can override these default values.
    def default_score_threshold_for_rs3_course_identifier_and_path_type(course_identifier, path_type)
      return 0.5 if course_identifier =~ /ENG-L\d+-NA-PT/ # placement test english has 50% for all path types
      case path_type
        when 'grammar', 'listening', 'listening_and_reading', 'reading', 'reading_color', 'early_reading', 'vocabulary'
          0.9
        when 'general', 'review', 'lagged_review'
          0.85
        when 'production_milestone', 'pronunciation', 'speaking', 'writing'
          0.75
      else
        raise "Unknown path type: #{path_type}"
      end
    end

    def valid_rs3_path_types
      # lagged_review is not a path_type ever specified in content, but the V4 app will send it to the TS on path_score updates while in an adaptive recall path.
      # we do not save those values into the path_scores table in the TS.
      %w(lagged_review early_reading general grammar listening listening_and_reading production_milestone pronunciation reading reading_color review speaking vocabulary writing)
    end

    def valid_rs3_path_type?(path_type)
      valid_rs3_path_types.include?(path_type.to_s)
    end

    # doc:rs3_demo_determination
    def demo_rs3_content?(product_identifier, unit, lesson)
      unit = unit.to_i
      raise ArgumentError, "Invalid unit: #{unit.inspect}" if unit < 1 || unit > 100
      lesson = lesson.to_i
      raise ArgumentError, "Invalid lesson: #{lesson.inspect}" if lesson < 1 || lesson > 100
      # The first unit and the first lesson of each level is demo.  it's that easy!
      return lesson == 1 && ((unit - 1) % 4) == 0
    end
    # !doc:rs3_demo_determination

  private
    def name_and_version_for(product_string, options = {})
      display_string = display_name_from_code_and_version(product_identifier_from(product_string), product_version_from(product_string), options)
      return '' if display_string.blank?
      display_string + ' ' + "V#{product_version_from(product_string)}"
    end

    def product_identifier_from(product_string)
      product_string.split('/').first
    end

    def product_version_from(product_string)
      product_string.split('/').last
    end
  end
end
